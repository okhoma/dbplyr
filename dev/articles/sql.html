<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writing SQL with dbplyr • dbplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<!--optional theme--><link href="../.css" rel="stylesheet">
<meta property="og:title" content="Writing SQL with dbplyr">
<meta property="og:description" content="dbplyr">
<meta property="og:image" content="https://dbplyr.tidyverse.org/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">dbplyr</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.4.4.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/dbplyr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/new-backend.html">Adding a new DBI backend</a>
    </li>
    <li>
      <a href="../articles/reprex.html">Reprexes for dbplyr</a>
    </li>
    <li>
      <a href="../articles/sql.html">Writing SQL with dbplyr</a>
    </li>
    <li>
      <a href="../articles/translation-function.html">Function translation</a>
    </li>
    <li>
      <a href="../articles/translation-verb.html">Verb translation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/dbplyr-1-4-0/">Version 1.4.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/01/dbplyr-1-3-0/">Version 1.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/01/dbplyr-1-2/">Version 1.2.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2017/06/27/dbplyr-1-1-0/">Version 1.1.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
        <li>
  <a href="https://github.com/tidyverse/dbplyr/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sql_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Writing SQL with dbplyr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dbplyr/blob/master/vignettes/sql.Rmd"><code>vignettes/sql.Rmd</code></a></small>
      <div class="hidden name"><code>sql.Rmd</code></div>

    </div>

    
    
<p>This vignette discusses why you might use dbplyr instead of writing SQL yourself, and what to do when dbplyr’s built-in translations can’t create the SQL that you need.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org">dplyr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dbplyr.tidyverse.org">dbplyr</a></span>)

<span class="kw">mf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/memdb_frame.html">memdb_frame</a></span>(x = <span class="fl">1</span>, y = <span class="fl">2</span>)
</pre></div>
<div id="why-use-dbplyr" class="section level2">
<h2 class="hasAnchor">
<a href="#why-use-dbplyr" class="anchor"></a>Why use dbplyr?</h2>
<p>One simple nicety of dplyr is that it will automatically generate subqueries if you want to use a freshly created variable in <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(
    a = <span class="kw">y</span> <span class="op">*</span> <span class="kw">x</span>, 
    b = <span class="kw">a</span> <span class="op">^</span> <span class="fl">2</span>,
  ) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT `x`, `y`, `a`, POWER(`a`, 2.0) AS `b`</span>
<span class="co">#&gt; FROM (SELECT `x`, `y`, `y` * `x` AS `a`</span>
<span class="co">#&gt; FROM `dbplyr_001`)</span>
</pre></div>
<p>In general, it’s much easier to work iteratively in dbplyr. You can easily give intermediate queries names, and reuse them in multiple places. Or if you have a common operation that you want to do to many queries, you can easily wrap it up in a function. It’s also easy to chain <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> to the end of any query to check the results are about what you expect.</p>
</div>
<div id="what-happens-when-dbplyr-fails" class="section level2">
<h2 class="hasAnchor">
<a href="#what-happens-when-dbplyr-fails" class="anchor"></a>What happens when dbplyr fails?</h2>
<p>dbplyr aims to translate the most common R functions to their SQL equivalents, allowing you to ignore the vagaries of the SQL dialect that you’re working with, so you can focus on the data analysis problem at hand. But different backends have different capabilities, and sometimes there are SQL functions that don’t have exact equivalents in R. In those cases, you’ll need to write SQL code directly. This section shows you how you can do so.</p>
<div id="prefix-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#prefix-functions" class="anchor"></a>Prefix functions</h3>
<p>Any function that dbplyr doesn’t know about will be left as is:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(z = <span class="fu">foofify</span>(<span class="kw">x</span>, <span class="kw">y</span>)) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT `x`, `y`, foofify(`x`, `y`) AS `z`</span>
<span class="co">#&gt; FROM `dbplyr_001`</span>
</pre></div>
<p>Because SQL functions are general case insensitive, I recommend using upper case when you’re using SQL functions in R code. That makes it easier to spot that you’re doing something unusual:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(z = <span class="fu">FOOFIFY</span>(<span class="kw">x</span>, <span class="kw">y</span>)) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT `x`, `y`, FOOFIFY(`x`, `y`) AS `z`</span>
<span class="co">#&gt; FROM `dbplyr_001`</span>
</pre></div>
</div>
<div id="infix-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#infix-functions" class="anchor"></a>Infix functions</h3>
<p>As well as prefix functions (where the name of the function comes before the arguments), dbplyr also translates infix functions. That allows you to use expressions like <code>LIKE</code> which does a limited form of pattern matching:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">x</span> <span class="op">%LIKE%</span> <span class="st">"%foo%"</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT *</span>
<span class="co">#&gt; FROM `dbplyr_001`</span>
<span class="co">#&gt; WHERE (`x` LIKE '%foo%')</span>
</pre></div>
<p>Or use <code><a href="https://rdrr.io/r/base/Logic.html">||</a></code> for string concatenation (note that backends should translate <code><a href="https://rdrr.io/r/base/paste.html">paste()</a></code> and <code><a href="https://rdrr.io/r/base/paste.html">paste0()</a></code> for you):</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(z = <span class="kw">x</span> <span class="op">%||%</span> <span class="kw">y</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT `x` || `y` AS `z`</span>
<span class="co">#&gt; FROM `dbplyr_001`</span>
</pre></div>
</div>
<div id="special-forms" class="section level3">
<h3 class="hasAnchor">
<a href="#special-forms" class="anchor"></a>Special forms</h3>
<p>SQL functions tend to have a greater variety of syntax than R. That means there are a number of expressions that can’t be translated directly from R code. To insert these in your own queries, you can use literal SQL inside <code><a href="../reference/sql.html">sql()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(factorial = <span class="fu"><a href="../reference/sql.html">sql</a></span>(<span class="st">"x!"</span>)) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT x! AS `factorial`</span>
<span class="co">#&gt; FROM `dbplyr_001`</span>

<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(factorial = <span class="fu"><a href="../reference/sql.html">sql</a></span>(<span class="st">"CAST(x AS FLOAT)"</span>)) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT CAST(x AS FLOAT) AS `factorial`</span>
<span class="co">#&gt; FROM `dbplyr_001`</span>
</pre></div>
<p>Note that you can use <code><a href="../reference/sql.html">sql()</a></code> at any depth inside the expression:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">mf</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">x</span> <span class="op">==</span> <span class="fu"><a href="../reference/sql.html">sql</a></span>(<span class="st">"ANY VALUES(1, 2, 3)"</span>)) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="co">#&gt; &lt;SQL&gt;</span>
<span class="co">#&gt; SELECT *</span>
<span class="co">#&gt; FROM `dbplyr_001`</span>
<span class="co">#&gt; WHERE (`x` = ANY VALUES(1, 2, 3))</span>
</pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>dbplyr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="http://hadley.nz">Hadley Wickham</a>, Edgar Ruiz, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
